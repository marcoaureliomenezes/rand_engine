# CI/CD Pipeline Documentation# CI/CD Pipeline Documentation# üöÄ CI/CD Workflows - Rand Engine



## Overview



Automated CI/CD pipeline with GitHub Actions for testing, security scanning, versioning, and PyPI publishing using Trusted Publishing (no tokens required).## Overview> Documenta√ß√£o completa do sistema de CI/CD com versionamento RC, seguran√ßa e visual summaries



**Key Features:** RC versioning for `development`, stable versioning for `master`, multi-platform testing (Ubuntu/Windows/macOS), Python 3.10-3.12, security scanning (SAST/CodeQL), optimized execution.



---This repository uses a fully automated CI/CD pipeline with GitHub Actions for testing, security scanning, versioning, and publishing to PyPI.## üìã √çndice



## Branch Strategy & Versioning



| Branch | Tag Format | PyPI Release | Source |### Key Features- [Vis√£o Geral](#-vis√£o-geral)

|--------|-----------|--------------|--------|

| `development` | `X.Y.Zrc[N]` (e.g., `0.5.5rc1`) | Pre-release | Auto-increments on each merge |- ‚úÖ Automated RC (Release Candidate) versioning for `development` branch- [Estrat√©gia de Versionamento](#-estrat√©gia-de-versionamento)

| `master` | `X.Y.Z` (e.g., `0.5.5`) | Stable | From `pyproject.toml` |

- ‚úÖ Automated stable versioning for `master` branch  - [Workflows Implementados](#-workflows-implementados)

**Version Source:** `pyproject.toml` - always use clean version without suffixes.

- ‚úÖ Multi-platform testing (Ubuntu, Windows, macOS)- [Seguran√ßa e Otimiza√ß√µes](#-seguran√ßa-e-otimiza√ß√µes)

**Flow Example:**

```- ‚úÖ Multi-version Python support (3.10, 3.11, 3.12)- [Visual Summaries](#-visual-summaries)

pyproject.toml: version = "0.5.5"

  ‚Üì- ‚úÖ Security scanning (SAST, dependency check, CodeQL)- [Fluxo Completo](#-fluxo-completo)

development merges ‚Üí 0.5.5rc1, 0.5.5rc2, 0.5.5rc3...

  ‚Üì- ‚úÖ PyPI Trusted Publishing (no tokens needed)- [Configura√ß√£o Necess√°ria](#-configura√ß√£o-necess√°ria)

master merge ‚Üí 0.5.5 (stable)

```- ‚úÖ Optimized test execution (no duplicate runs)- [Como Usar](#-como-usar)



**To Bump Version:** Edit `pyproject.toml`, commit, and merge to `development`.- [Troubleshooting](#-troubleshooting)



------- [Melhores Pr√°ticas](#-melhores-pr√°ticas)



## Workflows



### `test_on_push.yml`## Branch Strategy---

- **Trigger:** Push to feature branches (not `master`/`development`)

- **Action:** Runs tests (3 OS √ó 3 Python = 9 jobs) if NO open PR exists

- **Purpose:** Prevents duplicate test runs

### Protected Branches## üéØ Vis√£o Geral

### `pr_to_development.yml`

- **Trigger:** PR to `development`

- **Validates:** Source is NOT `master`

- **Runs:** Security (SAST/Semgrep/CodeQL), dependency scan, tests (3 OS √ó 3 Python), coverage (60% min), build validation| Branch | Purpose | Versioning | PyPI Release |Este projeto utiliza **CI/CD totalmente automatizado** com os seguintes princ√≠pios:

- **Required:** Must pass to merge

|--------|---------|------------|--------------|

### `pr_to_master.yml`

- **Trigger:** PR to `master`| `master` | Production stable releases | `X.Y.Z` (e.g., `0.5.5`) | Stable release |- ‚úÖ **Tags autom√°ticas** - Sem cria√ß√£o manual

- **Validates:** Source IS `development`

- **Runs:** Tests (3 OS √ó 3 Python), coverage (60% min)| `development` | Pre-release testing | `X.Y.Zrc[N]` (e.g., `0.5.5rc1`) | Pre-release |- ‚úÖ **Apenas RC** para pre-release (sem alpha/beta)

- **Required:** Must pass to merge

- ‚úÖ **Multi-job workflows** - Modularidade e clareza

### `auto_tag_publish_development.yml`

- **Trigger:** Merge to `development`### Working Branches- ‚úÖ **PyPI Trusted Publishing** - Sem tokens ou senhas

- **Actions:** 

  1. Determine next RC number (e.g., `0.5.5rc3`)Any other branch (feature branches, bugfix branches, etc.) - these are NOT protected.- ‚úÖ **Seguran√ßa em camadas** - SAST, dependency scanning, CodeQL

  2. Test (Python 3.10-3.12, Ubuntu only)

  3. Build package- ‚úÖ **Testes otimizados** - Sem duplica√ß√£o (~66% economia)

  4. Create git tag

  5. Publish to PyPI as pre-release---- ‚úÖ **Coverage enforcement** - M√≠nimo 60% obrigat√≥rio

  6. Create GitHub Release

- ‚úÖ **Melhores pr√°ticas** - Valida√ß√£o, testes, instala√ß√£o

### `auto_tag_publish_master.yml`

- **Trigger:** Merge to `master`## Versioning System- ‚úÖ **Observabilidade** - Logs detalhados e sum√°rios visuais

- **Actions:**

  1. Extract version from `pyproject.toml`

  2. Test (Python 3.10-3.12, Ubuntu only)

  3. Build package### Version Source of Truth### Estrutura de Branches

  4. Create git tag

  5. Publish to PyPI as stable release```toml

  6. Create GitHub Release

# pyproject.toml**Branches Protegidas:**

---

version = "0.5.5"  # Always clean version WITHOUT suffixes- `master` - Vers√µes est√°veis em produ√ß√£o

## Developer Guide

```- `development` - Vers√µes RC (Release Candidate)

### Feature Development

```bash

git checkout -b feature/xyz

git commit -am "feat: description"### How Versioning Works**Branches Desprotegidas:**

git push -u origin feature/xyz

gh pr create --base development- Qualquer outra branch (features, bugfixes, etc.)

# After merge ‚Üí auto-tagged as X.Y.Zrc[N] and published

```**Development Branch (RC - Release Candidate):**



### Production Release- First merge to `development` ‚Üí creates tag `0.5.5rc1`---

```bash

gh pr create --base master --head development --title "release: X.Y.Z"- Second merge to `development` ‚Üí creates tag `0.5.5rc2`  

# After merge ‚Üí tagged as X.Y.Z and published

```- Third merge to `development` ‚Üí creates tag `0.5.5rc3`## üì¶ Estrat√©gia de Versionamento



### Version Bump- And so on...

```bash

# Edit pyproject.toml: version = "0.6.0"### Fonte √önica de Verdade

git commit -am "chore: bump version to 0.6.0"

# PR to development ‚Üí creates 0.6.0rc1 on merge**Master Branch (Stable):**```toml

```

- Merge from `development` to `master` ‚Üí creates tag `0.5.5`# pyproject.toml

---

version = "0.5.5"  # Sempre vers√£o limpa, SEM sufixos

## Security & Testing

### How to Change Version```

### Security Tools

- **SAST:** Bandit (Python security), Semgrep (patterns)

- **Dependencies:** Safety, pip-audit

- **Code Analysis:** CodeQL1. Edit `pyproject.toml`:### Versionamento Sem√¢ntico

- **Publishing:** PyPI Trusted Publishing (OIDC-based)

   ```toml

### Test Matrix

- **PR workflows:** Ubuntu/Windows/macOS √ó Python 3.10/3.11/3.12   version = "0.6.0"  # Update to new version| Ambiente | Formato | Exemplo | Uso |

- **Publish workflows:** Ubuntu only √ó Python 3.10/3.11/3.12

- **Coverage:** 60% minimum (enforced on Python 3.12 + Ubuntu)   ```|----------|---------|---------|-----|



---| **Development** | `X.Y.Zrc[N]` | `0.5.5rc1`, `0.5.5rc2` | Pre-releases no PyPI |



## Configuration2. Commit and create PR:| **Master** | `X.Y.Z` | `0.5.5` | Vers√£o est√°vel no PyPI |



### Branch Protection   ```bash

**`development`:** Require PR + passing checks (validation, tests, security, build)  

**`master`:** Require PR + passing checks (validation from `development`, tests)   git add pyproject.toml### Fluxo de Vers√µes



### PyPI Trusted Publishing   git commit -m "chore: bump version to 0.6.0"

Configure at PyPI project settings ‚Üí Publishing ‚Üí Add publisher:

- **Project:** `rand-engine`   git push```

- **Owner:** `marcoaureliomenezes`

- **Repo:** `rand_engine`   ```pyproject.toml: version = "0.5.5"

- **Workflows:** `auto_tag_publish_development.yml`, `auto_tag_publish_master.yml`

         ‚Üì

---

3. After PR is merged to `development`:    DEVELOPMENT

## Troubleshooting

   - Tag `0.6.0rc1` is automatically created         ‚Üì

| Issue | Solution |

|-------|----------|   - Package is published to PyPI as pre-release   PR Merged #1 ‚Üí 0.5.5rc1 (PyPI pre-release)

| PyPI upload fails | Verify Trusted Publishing config matches repo owner/name/workflow exactly |

| PySpark tests crash on Windows | Expected - auto-skipped on Windows + Python 3.12 |   PR Merged #2 ‚Üí 0.5.5rc2 (PyPI pre-release)

| RC number doesn't increment | Check tags were created/pushed: `git push --tags` |

| Coverage fails | Add tests or adjust threshold (not recommended) |---   PR Merged #3 ‚Üí 0.5.5rc3 (PyPI pre-release)



---         ‚Üì



## Best Practices## Workflows    PR ‚Üí MASTER



**DO:** Create PRs, write tests, keep `pyproject.toml` clean (no suffixes), use semantic commits           ‚Üì

**DON'T:** Create tags manually, push to protected branches, add version suffixes, merge `master` ‚Üí `development`

### 1. `test_on_push.yml` - Tests on Feature Branches   PR Merged ‚Üí 0.5.5 (PyPI stable)

---

**Trigger:** Push to any branch EXCEPT `master` and `development````

## Monitoring



```bash

gh run list --limit 10           # Check workflow runs**What it does:**### Mudan√ßa de Vers√£o

gh release list                   # View releases

pip index versions rand-engine    # Check PyPI versions- Checks if an open PR exists for the branch

```

- If NO PR: Runs full test suite (3 OS √ó 3 Python versions = 9 jobs)Para mudar a vers√£o, edite **apenas** `pyproject.toml`:

- If PR exists: Skips (tests will run in PR workflow)

```bash

**Why:** Prevents duplicate test runs when you push to a branch with an open PR.# Editar pyproject.toml

version = "0.5.6"

### 2. `pr_to_development.yml` - PR Validation for Development

**Trigger:** PR opened/updated targeting `development` branch# Commit e PR ‚Üí development

git add pyproject.toml

**What it does:**git commit -m "chore: bump version to 0.5.6"

1. **Validation**: Ensures PR is NOT from `master` branch# Ap√≥s merge: 0.5.6rc1 ser√° criada automaticamente

2. **Security Scans**:```

   - SAST (Static Application Security Testing) with Bandit + Semgrep

   - Dependency vulnerability scanning with Safety + pip-audit---

   - CodeQL analysis for code security issues

3. **Tests**: Full test suite (3 OS √ó 3 Python versions)## ÔøΩÔ∏è Seguran√ßa e Otimiza√ß√µes

4. **Coverage**: Enforces minimum 60% code coverage

5. **Quality Checks**: Validates package building and installation### ‚úÖ Problema Resolvido: Testes Duplicados



**Branch Protection:** This workflow MUST pass before merging to `development`.**Antes:**

```

### 3. `pr_to_master.yml` - PR Validation for MasterPush em feature ‚Üí test_on_push.yml executa

**Trigger:** PR opened/updated targeting `master` branchAbrir PR ‚Üí pr_to_development.yml executa (DUPLICADO)

Push no PR ‚Üí pr_to_development.yml executa (TRIPLICADO)

**What it does:**```

1. **Validation**: Ensures PR comes ONLY from `development` branch

2. **Tests**: Full test suite (3 OS √ó 3 Python versions)**Depois:**

3. **Coverage**: Enforces minimum 60% code coverage```

Push em feature (sem PR) ‚Üí test_on_push.yml executa

**Branch Protection:** This workflow MUST pass before merging to `master`.Push em feature (com PR aberto) ‚Üí test_on_push.yml SKIP ‚è≠Ô∏è

Abrir PR ‚Üí pr_to_development.yml executa (√öNICA VEZ)

### 4. `auto_tag_publish_development.yml` - Deploy to DevelopmentPush no PR ‚Üí pr_to_development.yml executa (ATUALIZA√á√ÉO)

**Trigger:** PR merged to `development` branch```



**What it does:****Economia:** ~66% menos execu√ß√µes de testes!

1. **Prepare**: Extracts version from `pyproject.toml` and determines next RC number

2. **Test**: Runs tests on Python 3.10, 3.11, 3.12 (Ubuntu only)### üîí Camadas de Seguran√ßa Implementadas

3. **Build**: Creates wheel and source distribution

4. **Validate**: Tests package installation and basic imports#### 1. SAST - Static Application Security Testing

5. **Tag**: Creates git tag (e.g., `0.5.5rc1`)

6. **Publish**: Uploads to PyPI as pre-release using Trusted Publishing**Bandit (Python Security Scanner)**

7. **Release**: Creates GitHub Release with changelog- Detecta vulnerabilidades comuns no c√≥digo Python

- Exemplos: `eval()`, `exec()`, SQL injection, hardcoded passwords, weak cryptography

**Example Flow:**- Configura√ß√£o: `.bandit` suprime falsos positivos (B101, B311, B324)

```- Status: ‚ö†Ô∏è Warning (n√£o bloqueia PR)

pyproject.toml: version = "0.5.5"

  ‚Üì**Semgrep (Advanced Static Analysis)**

Merge PR #1 ‚Üí Tag: 0.5.5rc1 ‚Üí PyPI: rand-engine==0.5.5rc1- An√°lise sem√¢ntica avan√ßada

Merge PR #2 ‚Üí Tag: 0.5.5rc2 ‚Üí PyPI: rand-engine==0.5.5rc2- Exemplos: Code injection, insecure deserialization, path traversal, XSS

Merge PR #3 ‚Üí Tag: 0.5.5rc3 ‚Üí PyPI: rand-engine==0.5.5rc3- Status: ‚ö†Ô∏è Warning (n√£o bloqueia PR)

```

#### 2. Dependency Scanning

### 5. `auto_tag_publish_master.yml` - Deploy to Production

**Trigger:** PR merged to `master` branch**Safety (Python Package Vulnerabilities)**

- Verifica vulnerabilidades conhecidas em depend√™ncias

**What it does:**- Database: CVE (Common Vulnerabilities and Exposures)

1. **Prepare**: Extracts version and checks if tag already exists- Status: ‚ö†Ô∏è Warning (n√£o bloqueia PR)

2. **Test**: Runs tests on Python 3.10, 3.11, 3.12 (Ubuntu only)

3. **Build**: Creates wheel and source distribution**Trivy (Comprehensive Scanner)**

4. **Validate**: Tests package installation and basic imports  - Scanner multi-prop√≥sito: vulnerabilidades, misconfigura√ß√µes, secrets, licenses

5. **Tag**: Creates git tag (e.g., `0.5.5`)- Upload SARIF para GitHub Security tab

6. **Publish**: Uploads to PyPI as stable release using Trusted Publishing- Status: ‚ö†Ô∏è Warning (n√£o bloqueia PR)

7. **Release**: Creates GitHub Release with changelog

#### 3. CodeQL (GitHub Advanced Security)

**Example Flow:**

```- An√°lise sem√¢ntica profunda (gratuito para repos p√∫blicos)

pyproject.toml: version = "0.5.5"- Queries: security-extended + security-and-quality

  ‚Üì- Taint analysis, data flow analysis, control flow analysis, CWE detection

Merge PR from development ‚Üí Tag: 0.5.5 ‚Üí PyPI: rand-engine==0.5.5 (stable)- Status: ‚ö†Ô∏è Warning (n√£o bloqueia PR)

```

#### 4. Coverage Enforcement

---

- **M√≠nimo:** 60% de cobertura de testes

## Developer Workflows- **Bloqueio:** PR n√£o pode ser mergeado se coverage < 60%

- **Status:** ‚ùå Blocker (falha CI se n√£o atender)

### Working on a Feature

### üö® Pol√≠tica de Seguran√ßa

```bash

# 1. Create feature branch**‚ùå Blockers (PR n√£o pode ser mergeado):**

git checkout -b feature/my-feature1. Testes falhando

2. Coverage < 60%

# 2. Make changes and commit3. Valida√ß√£o de source branch falhar

git add .

git commit -m "feat: add new feature"**‚ö†Ô∏è Warnings (Review necess√°rio, mas n√£o bloqueia):**

1. Vulnerabilidades detectadas pelo Bandit

# 3. Push to remote2. Issues encontrados pelo Semgrep

git push -u origin feature/my-feature3. Vulnerabilidades em depend√™ncias (Safety/Trivy)

# ‚úÖ test_on_push.yml runs automatically4. Findings do CodeQL



# 4. Create PR to development**Raz√£o:** Nem todo "finding" √© um problema real. Falsos positivos s√£o comuns, especialmente em bibliotecas de gera√ß√£o de dados de teste.

gh pr create --base development --title "feat: add new feature"

# ‚úÖ pr_to_development.yml runs (includes security scans)### üîß Fix: Poetry Export Error



# 5. After PR approval and merge**Problema:** `The requested command export does not exist.`

# ‚úÖ auto_tag_publish_development.yml runs

# ‚úÖ Creates tag like 0.5.5rc1**Solu√ß√£o:** Desde Poetry 1.2+, o comando `export` foi movido para plugin separado.

# ‚úÖ Publishes to PyPI as pre-release

``````yaml

- name: Install Poetry Export Plugin

### Releasing to Production  run: poetry self add poetry-plugin-export



```bash- name: Export requirements

# 1. Create PR from development to master  run: poetry export -f requirements.txt --output requirements.txt --without-hashes

gh pr create --base master --head development --title "release: version 0.5.5"```

# ‚úÖ pr_to_master.yml runs

### üõ°Ô∏è SQL Injection Protection

# 2. After PR approval and merge

# ‚úÖ auto_tag_publish_master.yml runsImplementado valida√ß√£o de input em handlers de banco de dados:

# ‚úÖ Creates tag 0.5.5

# ‚úÖ Publishes to PyPI as stable release```python

```# Valida table names (apenas alphanumeric + underscore)

if not table_name.replace('_', '').isalnum():

### Bumping Version    raise ValueError(f"Invalid table name: {table_name}")

```

```bash

# 1. Edit pyproject.tomlArquivos protegidos:

version = "0.6.0"- `rand_engine/integrations/duckdb_handler.py`

- `rand_engine/integrations/sqlite_handler.py`

# 2. Commit and create PR

git add pyproject.toml### üìä Arquitetura de Seguran√ßa

git commit -m "chore: bump version to 0.6.0"

git push```

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê

# 3. Create PR to development‚îÇ               PR para Development Branch                 ‚îÇ

gh pr create --base development‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

                         ‚îÇ

# 4. After merge        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê

# ‚úÖ First merge creates: 0.6.0rc1        ‚Üì                ‚Üì                ‚Üì              ‚Üì

# ‚úÖ Second merge creates: 0.6.0rc2‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê

# etc...‚îÇ   SAST       ‚îÇ  ‚îÇ Dependency   ‚îÇ  ‚îÇ CodeQL   ‚îÇ  ‚îÇ  Tests   ‚îÇ

```‚îÇ  Analysis    ‚îÇ  ‚îÇ   Scanning   ‚îÇ  ‚îÇ Analysis ‚îÇ  ‚îÇ + Cov    ‚îÇ

‚îÇ              ‚îÇ  ‚îÇ              ‚îÇ  ‚îÇ          ‚îÇ  ‚îÇ  ‚â•60%    ‚îÇ

---‚îÇ ‚Ä¢ Bandit     ‚îÇ  ‚îÇ ‚Ä¢ Safety     ‚îÇ  ‚îÇ ‚Ä¢ Taint  ‚îÇ  ‚îÇ          ‚îÇ

‚îÇ ‚Ä¢ Semgrep    ‚îÇ  ‚îÇ ‚Ä¢ Trivy      ‚îÇ  ‚îÇ ‚Ä¢ Data   ‚îÇ  ‚îÇ ‚Ä¢ Pytest ‚îÇ

## Security Features‚îÇ              ‚îÇ  ‚îÇ              ‚îÇ  ‚îÇ   Flow   ‚îÇ  ‚îÇ ‚Ä¢ Cov    ‚îÇ

‚îÇ Status: ‚ö†Ô∏è   ‚îÇ  ‚îÇ Status: ‚ö†Ô∏è   ‚îÇ  ‚îÇ Status:‚ö†Ô∏è‚îÇ  ‚îÇStatus: ‚ùå‚îÇ

### 1. SAST (Static Application Security Testing)‚îÇ (Warning)    ‚îÇ  ‚îÇ (Warning)    ‚îÇ  ‚îÇ(Warning) ‚îÇ  ‚îÇ(Blocker) ‚îÇ

- **Bandit**: Python security linter - finds common security issues‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

- **Semgrep**: Multi-language static analysis - detects security patterns        ‚îÇ                ‚îÇ                ‚îÇ              ‚îÇ

        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

### 2. Dependency Scanning                           ‚îÇ

- **Safety**: Checks for known vulnerabilities in Python dependencies                         ‚Üì

- **pip-audit**: Audits Python packages for security vulnerabilities              ‚úÖ READY TO MERGE (if tests pass)

              ‚ö†Ô∏è  REVIEW SECURITY FINDINGS

### 3. CodeQL Analysis```

- Advanced semantic code analysis

- Detects security vulnerabilities and coding errors### üîß Ferramentas e Custos

- Runs on every PR to `development`

| Ferramenta | Tipo | Custo | Onde Executa |

### 4. PyPI Trusted Publishing|------------|------|-------|--------------|

- No API tokens or passwords stored| **Bandit** | SAST Python | Gr√°tis | GitHub Actions |

- Uses OpenID Connect (OIDC) for authentication| **Semgrep** | SAST Universal | Gr√°tis (Community) | GitHub Actions |

- More secure than traditional token-based publishing| **Safety** | Dependency | Gr√°tis (DB b√°sico) | GitHub Actions |

| **Trivy** | Multi-scanner | Gr√°tis (Open Source) | GitHub Actions |

---| **CodeQL** | Advanced SAST | Gr√°tis (repos p√∫blicos) | GitHub Actions |

| **pytest-cov** | Coverage | Gr√°tis | GitHub Actions |

## Testing Strategy| **Codecov** | Coverage Viz | Gr√°tis (repos p√∫blicos) | Cloud |



### Test Matrix**Total:** R$ 0,00 para reposit√≥rios p√∫blicos! üéâ

| OS | Python Versions | When |

|----|----------------|------|---

| Ubuntu | 3.10, 3.11, 3.12 | All workflows |

| Windows | 3.10, 3.11, 3.12 | PR workflows only |## üìä Visual Summaries

| macOS | 3.10, 3.11, 3.12 | PR workflows only |

### Todos os Workflows t√™m Summaries Visuais

### Coverage Requirements

- Minimum: 60%#### 1. `test_on_push.yml` - 3 Cen√°rios

- Measured on Python 3.12 + Ubuntu

- Enforced in PR workflows**Cen√°rio A: Tests Executados com Sucesso ‚úÖ**

```markdown

### Optimizations# üß™ Test Results - Feature Branch

- **No duplicate runs**: If PR exists, `test_on_push.yml` skips- Branch info table

- **OS optimization**: Publish workflows only test on Ubuntu- Test execution status (all ‚úÖ)

- **Caching**: Poetry dependencies are cached for faster runs- Next steps: Create PR commands and links

```

---

**Cen√°rio B: Tests Executados com Falha ‚ùå**

## Configuration Requirements```markdown

# üß™ Test Results - Feature Branch

### GitHub Settings- Branch info table

- Test execution status (with ‚ùå)

#### 1. Branch Protection Rules- Debugging steps and local test commands

```

**For `development` branch:**

- Require a pull request before merging**Cen√°rio C: Tests Pulados (PR existe) ‚è≠Ô∏è**

- Require status checks to pass:```markdown

  - `Validate PR Source`# üß™ Test Results - Feature Branch

  - `Run Tests (all matrix combinations)`- Branch info table

  - `Security - SAST`- Explanation: Tests run on PR workflow

  - `Security - Dependency Scanning`- Link to PR checks

  - `Security - CodeQL````

  - `Build and Validate Package`

#### 2. `pr_to_development.yml` - Security + Tests

**For `master` branch:**

- Require a pull request before merging```markdown

- Require status checks to pass:# üîç Security & Test Validation

  - `Validate PR from Development`- Security analysis results (4 tools)

  - `Run Tests (all matrix combinations)`- Test results matrix (Python 3.10, 3.11, 3.12)

- Coverage status

#### 2. PyPI Trusted Publishing- Links to artifacts

```

Go to PyPI project settings:

1. Navigate to: Publishing ‚Üí Add a new publisher#### 3. `auto_tag_publish_development.yml` - RC Deployment

2. Configure:

   - **PyPI Project Name**: `rand-engine````markdown

   - **Owner**: `marcoaureliomenezes`# üì¶ RC Deployment Complete

   - **Repository**: `rand_engine`- Version info (e.g., 0.5.5rc1)

   - **Workflow name**: `auto_tag_publish_development.yml`- Pipeline status table (all 7 jobs)

   - **Environment name**: leave blank- PyPI pre-release link

- GitHub Pre-Release link

3. Repeat for `auto_tag_publish_master.yml`- Installation commands

- Testing instructions

### Repository Secrets```



No secrets are needed! PyPI Trusted Publishing uses OIDC.#### 4. `auto_tag_publish_master.yml` - Production Deployment



---**Success Scenario:**

```markdown

## Troubleshooting# üéâ Production Deployment Complete!

- Version info with RC promotion details

### Build Fails on PyPI Upload- Pipeline status table (all 6 jobs)

- Direct links to PyPI and GitHub Release

**Problem:** `Error: Invalid or non-existent authentication information`- Installation: pip install rand-engine==X.Y.Z

- Testing instructions

**Solution:** - Next steps suggestions

1. Check PyPI Trusted Publishing is configured correctly```

2. Verify repository owner and name match exactly

3. Ensure workflow name is spelled correctly**Skip Scenario (tag exists):**

```markdown

### Tests Fail Only on Windows# ‚è≠Ô∏è Deployment Skipped

- Tag already exists explanation

**Problem:** PySpark tests crash on Windows + Python 3.12- Links to existing release

- Guidance on creating new version

**Solution:** ```

This is expected. Tests automatically skip PySpark on Windows + Python 3.12.

See `tests/fixtures/f5_spark_fixtures.py` for the skip logic.### üé® Benef√≠cios dos Summaries



### RC Number Doesn't Increment1. **Visibilidade Total**: Status de cada job em formato tabela

2. **Documenta√ß√£o Autom√°tica**: Comandos prontos para copiar

**Problem:** Multiple merges create the same RC tag3. **Debugging Facilitado**: Mensagens claras sobre o que fazer

4. **Profissionalismo**: UX consistente e visual atraente

**Solution:**5. **Orienta√ß√£o Clara**: Pr√≥ximos passos baseados no contexto

1. Check that previous tags were created successfully

2. Verify git tags are pushed to remote: `git push --tags`---

3. The workflow uses `git tag -l` to find existing RCs



### Coverage Below 60%## üîÑ Workflows Implementados



**Problem:** PR fails due to low coverage### 1. `test_on_push.yml` - Testes em Feature Branches



**Solution:****Trigger:** Push em qualquer branch **exceto** `master` e `development`

1. Add tests for new code

2. Or adjust the threshold in workflow files (not recommended)**Jobs:**

1. **check_pr**: Detecta se PR existe (usando GitHub CLI)

---2. **test**: Testes Python 3.10, 3.11, 3.12 (apenas se n√£o houver PR)

3. **summary**: Visual report com 3 cen√°rios (success/failure/skip)

## Best Practices

**Fun√ß√£o:**

### DO ‚úÖ- Testes autom√°ticos antes de criar PRs

- Always create PRs for changes (even small ones)- Skip inteligente se PR j√° existe (evita duplica√ß√£o)

- Write tests for new features- Cobertura de testes

- Keep version in `pyproject.toml` clean (no `-rc` suffixes)- Orienta√ß√£o sobre pr√≥ximos passos

- Test RC versions before promoting to master

- Use semantic commit messages (`feat:`, `fix:`, `chore:`)**Uso:** Desenvolvimento local em feature branches



### DON'T ‚ùå---

- Don't create tags manually

- Don't push directly to `master` or `development`### 2. `pr_to_development.yml` - Valida√ß√£o de PR + Security

- Don't add version suffixes to `pyproject.toml`

- Don't merge `master` back into `development`**Trigger:** Pull Request para `development`

- Don't skip security scan failures without investigation

**Jobs:**

---1. **validate_source**: Source branch ‚â† master

2. **security_sast**: Bandit + Semgrep (‚ö†Ô∏è warning)

## Monitoring3. **security_dependencies**: Safety + Trivy (‚ö†Ô∏è warning)

4. **security_codeql**: GitHub Advanced Security (‚ö†Ô∏è warning)

### Check Workflow Status5. **test**: Python 3.10, 3.11, 3.12 + Coverage ‚â•60% (‚ùå blocker)

```bash6. **summary**: Status de todos os checks

gh run list --limit 10

gh run view <run-id>**Valida√ß√µes:**

```- ‚úÖ An√°lise de seguran√ßa em 5 ferramentas

- ‚úÖ Coverage enforcement (m√≠nimo 60%)

### View Recent Releases- ‚úÖ Poetry export plugin instalado automaticamente

```bash- ‚úÖ Upload SARIF para GitHub Security tab

gh release list

```**Uso:** Valida√ß√£o antes de merge em `development`



### Check PyPI Versions---

```bash

pip index versions rand-engine### 3. `pr_to_master.yml` - Valida√ß√£o Strict

```

**Trigger:** Pull Request para `master`

---

**Valida√ß√µes:**

## Additional Resources- ‚úÖ Source branch **deve** ser `development` (apenas!)

- ‚úÖ Testes completos em Python 3.10, 3.11, 3.12

- [GitHub Actions Documentation](https://docs.github.com/en/actions)- ‚úÖ Coverage upload para Codecov

- [PyPI Trusted Publishing](https://docs.pypi.org/trusted-publishers/)

- [Semantic Versioning](https://semver.org/)**Uso:** Valida√ß√£o antes de release est√°vel

- [PEP 440 - Version Identification](https://peps.python.org/pep-0440/)

---

### 4. `auto_tag_publish_development.yml` - RC Deployment

**Trigger:** Pull Request **merged** em `development`

**Arquitetura:** 7 jobs modulares

#### Job 1: Prepare
- Extrai vers√£o do `pyproject.toml`
- Determina pr√≥xima RC tag (rc1, rc2, rc3, ...)
- Valida formato da vers√£o

#### Job 2: Test
- Testes em Python 3.10, 3.11, 3.12 (matriz)
- Upload de coverage para Codecov
- Cache de depend√™ncias Poetry

#### Job 3: Build
- Atualiza vers√£o para RC usando `poetry version $RC_TAG`
- Build do pacote (wheel + source distribution)
- Valida√ß√£o de metadata com `twine check`
- Teste de instala√ß√£o do pacote

#### Job 4: Create Tag
- Cria tag RC anotada automaticamente
- Push da tag para o reposit√≥rio
- Mensagem detalhada com metadata

#### Job 5: Publish PyPI
- Publica no PyPI usando OIDC (Trusted Publishing)
- Environment: `development`
- Vers√£o como pre-release

#### Job 6: Create GitHub Release
- Cria GitHub Pre-Release
- Changelog autom√°tico desde √∫ltimo RC
- Artifacts do build anexados
- Instru√ß√µes de instala√ß√£o

#### Job 7: Summary
- Sum√°rio visual do deployment
- Links para PyPI e GitHub Release
- Status de cada job
- Pr√≥ximos passos sugeridos

**Outputs:**
```yaml
version: "0.5.5"           # Base version
rc_tag: "0.5.5rc1"         # Full RC tag
rc_number: "1"             # RC number
```

---

### 5. `auto_tag_publish_master.yml` - Production Deployment

**Trigger:** Pull Request **merged** em `master`

**Arquitetura:** 6 jobs principais + skip notification

#### Job 1: Prepare
- Extrai vers√£o do `pyproject.toml`
- Verifica se tag j√° existe (evita republica√ß√£o)
- Valida que vers√£o **n√£o tem sufixo RC**
- Encontra √∫ltimo RC tag (para changelog)

#### Job 2: Test
- Testes em Python 3.10, 3.11, 3.12
- Executa apenas se tag n√£o existir

#### Job 3: Build
- Build do pacote (vers√£o limpa, sem RC)
- Valida√ß√£o de metadata
- Teste de instala√ß√£o

#### Job 4: Create Tag
- Cria tag de produ√ß√£o (sem sufixo)
- Mensagem com promo√ß√£o de RC (se existir)

#### Job 5: Publish PyPI
- Publica no PyPI como vers√£o est√°vel
- Environment: `production`

#### Job 6: Create GitHub Release
- Cria GitHub Release (n√£o pre-release)
- Changelog desde √∫ltimo RC ou stable
- Mostra qual RC foi promovido
- Artifacts anexados

#### Job 7: Summary
- Sum√°rio visual do deployment
- Informa√ß√µes de vers√£o e RC promovido
- Status de cada job (‚úÖ/‚ùå)
- Links para PyPI e GitHub Release
- Comandos de instala√ß√£o e testes
- Pr√≥ximos passos sugeridos
- Determina sucesso/falha com exit codes

#### Job 8: Skip Notification
- Executa quando tag j√° existe
- Explica por que deployment foi pulado
- Links para release existente
- Orienta√ß√£o sobre como criar nova vers√£o

**Outputs:**
```yaml
version: "0.5.5"           # Production version
tag_exists: "false"        # Se j√° existe
latest_rc: "0.5.5rc3"      # √öltimo RC (se existir)
```

---

## üîß Troubleshooting

### Poetry Export Error

**Sintoma:** `The requested command export does not exist.`

**Causa:** Plugin poetry-plugin-export n√£o instalado (obrigat√≥rio desde Poetry 1.2+)

**Solu√ß√£o:** J√° implementada nos workflows - instala automaticamente:
```yaml
- name: Install Poetry Export Plugin
  run: poetry self add poetry-plugin-export
```

### Bandit False Positives

**Sintoma:** Bandit reporta issues em c√≥digo de teste/mock data

**Causa:** Biblioteca gera dados aleat√≥rios para testes (uso leg√≠timo de `random`, `assert`, `hashlib`)

**Solu√ß√£o:** Configura√ß√£o `.bandit` j√° criada:
```ini
[bandit]
skips = B101,B311,B324  # assert, random, hashlib
```

### Trivy Upload Error

**Sintoma:** `Error: Unable to upload SARIF file`

**Causa:** Trivy pode n√£o gerar SARIF em algumas situa√ß√µes

**Solu√ß√£o:** J√° implementada - `continue-on-error: true` nos jobs de seguran√ßa

### Coverage Failure

**Sintoma:** `Error: coverage is less than 60%`

**Causa:** C√≥digo novo sem testes adequados

**Solu√ß√£o:** Adicionar testes para cobrir pelo menos 60% do c√≥digo
```bash
# Rodar localmente para ver coverage
poetry run pytest tests/ --cov=rand_engine --cov-report=html
# Abrir htmlcov/index.html para ver detalhes
```

### Tag Already Exists

**Sintoma:** Deployment skip notification

**Causa:** Vers√£o j√° foi publicada anteriormente

**Solu√ß√£o:** Atualizar vers√£o no `pyproject.toml`:
```toml
[tool.poetry]
version = "0.5.6"  # Incrementar vers√£o
```

### PyPI Publishing Error

**Sintoma:** `invalid-publisher: valid token, but no corresponding publisher`

**Causa:** PyPI Trusted Publishing n√£o configurado corretamente

**Solu√ß√£o:** Verificar configura√ß√£o no PyPI:
- Workflow name deve ser exato: `auto_tag_publish_development.yml` ou `auto_tag_publish_master.yml`
- Owner e repo devem corresponder exatamente
- Ver se√ß√£o [Configura√ß√£o PyPI](#-configura√ß√£o-necess√°ria)

---

## üéØ Fluxo Completo

### Diagrama ASCII

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      FEATURE BRANCH                              ‚îÇ
‚îÇ                   (feature/nova-feature)                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚îÇ git push
                           ‚Üì
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ   test_on_push.yml     ‚îÇ
              ‚îÇ  Python 3.10-3.12      ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚îÇ Criar PR ‚Üí development
                           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                       PULL REQUEST                               ‚îÇ
‚îÇ                      ‚Üí development                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚Üì
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ pr_to_development.yml  ‚îÇ
              ‚îÇ  ‚úì Source ‚â† master     ‚îÇ
              ‚îÇ  ‚úì Tests + Coverage    ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚îÇ ‚úÖ MERGE PR
                           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   DEVELOPMENT BRANCH                             ‚îÇ
‚îÇ                      (protected)                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ auto_tag_publish_development.yml (7 jobs)    ‚îÇ
    ‚îÇ  1. Prepare    ‚Üí Determina RC tag            ‚îÇ
    ‚îÇ  2. Test       ‚Üí Python 3.10, 3.11, 3.12     ‚îÇ
    ‚îÇ  3. Build      ‚Üí poetry version $RC_TAG      ‚îÇ
    ‚îÇ  4. Create Tag ‚Üí 0.5.5rc1, 0.5.5rc2, ...     ‚îÇ
    ‚îÇ  5. Publish    ‚Üí PyPI (pre-release)          ‚îÇ
    ‚îÇ  6. Release    ‚Üí GitHub Pre-Release          ‚îÇ
    ‚îÇ  7. Summary    ‚Üí Visual deployment report     ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚îÇ Valida√ß√£o e testes
                           ‚îÇ Criar PR ‚Üí master
                           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                       PULL REQUEST                               ‚îÇ
‚îÇ                        ‚Üí master                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚Üì
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ   pr_to_master.yml     ‚îÇ
              ‚îÇ  ‚úì Source = development‚îÇ
              ‚îÇ  ‚úì Tests + Coverage    ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚îÇ ‚úÖ MERGE PR
                           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      MASTER BRANCH                               ‚îÇ
‚îÇ                      (protected)                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ   auto_tag_publish_master.yml (6 jobs)       ‚îÇ
    ‚îÇ  1. Prepare    ‚Üí Extrai vers√£o, valida       ‚îÇ
    ‚îÇ  2. Test       ‚Üí Python 3.10, 3.11, 3.12     ‚îÇ
    ‚îÇ  3. Build      ‚Üí Vers√£o limpa (sem RC)       ‚îÇ
    ‚îÇ  4. Create Tag ‚Üí 0.5.5                       ‚îÇ
    ‚îÇ  5. Publish    ‚Üí PyPI (stable)               ‚îÇ
    ‚îÇ  6. Release    ‚Üí GitHub Release              ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚Üì
                   ‚úÖ PRODUCTION READY
```

### Exemplos Pr√°ticos

#### Cen√°rio 1: Nova Feature
```bash
# 1. Criar feature branch
git checkout -b feature/minha-feature

# 2. Desenvolver
# ... editar c√≥digo ...

# 3. Commit e push
git add .
git commit -m "feat: adiciona nova feature"
git push origin feature/minha-feature
# ‚Üí test_on_push.yml executa automaticamente

# 4. Criar PR para development (GitHub UI)
# ‚Üí pr_to_development.yml valida

# 5. Merge PR
# ‚Üí auto_tag_publish_development.yml
# ‚Üí Tag 0.5.5rc1 criada
# ‚Üí PyPI: 0.5.5rc1 (pre-release)
# ‚Üí GitHub: Pre-Release 0.5.5rc1
```

#### Cen√°rio 2: M√∫ltiplas RCs
```bash
# PR 1 mergeado ‚Üí 0.5.5rc1
# PR 2 mergeado ‚Üí 0.5.5rc2
# PR 3 mergeado ‚Üí 0.5.5rc3
# ... at√© estar pronto
```

#### Cen√°rio 3: Release Est√°vel
```bash
# 1. Criar PR: development ‚Üí master (GitHub UI)
# ‚Üí pr_to_master.yml valida (strict: source deve ser development)

# 2. Merge PR
# ‚Üí auto_tag_publish_master.yml
# ‚Üí Tag 0.5.5 criada
# ‚Üí PyPI: 0.5.5 (stable)
# ‚Üí GitHub: Release 0.5.5 (promovido de 0.5.5rc3)
```

#### Cen√°rio 4: Bump de Vers√£o
```bash
# 1. Editar pyproject.toml
version = "0.5.6"

# 2. Commit
git add pyproject.toml
git commit -m "chore: bump version to 0.5.6"

# 3. Push e criar PR ‚Üí development

# 4. Ap√≥s merge:
# ‚Üí Tag 0.5.6rc1 criada automaticamente
```

---

## üîê Configura√ß√£o Necess√°ria

### PyPI Trusted Publishing (OIDC)

**‚ö†Ô∏è CR√çTICO:** Configure no PyPI antes de usar os workflows

#### URL de Configura√ß√£o
https://pypi.org/manage/project/rand-engine/settings/publishing/

#### Publisher 1: Development (Pre-Release)

| Campo | Valor |
|-------|-------|
| **PyPI Project Name** | `rand-engine` |
| **Owner** | `marcoaureliomenezes` |
| **Repository name** | `rand_engine` |
| **Workflow name** | `auto_tag_publish_development.yml` |
| **Environment name** | `development` *(opcional)* |

#### Publisher 2: Master (Stable Release)

| Campo | Valor |
|-------|-------|
| **PyPI Project Name** | `rand-engine` |
| **Owner** | `marcoaureliomenezes` |
| **Repository name** | `rand_engine` |
| **Workflow name** | `auto_tag_publish_master.yml` |
| **Environment name** | `production` *(opcional)* |

#### Vantagens do Trusted Publishing
- ‚úÖ Sem API tokens ou senhas
- ‚úÖ Seguran√ßa baseada em OIDC (OpenID Connect)
- ‚úÖ Configura√ß√£o por workflow espec√≠fico
- ‚úÖ Audit trail completo no GitHub
- ‚úÖ Zero secrets para gerenciar

#### Troubleshooting

**Erro:** `invalid-publisher: valid token, but no corresponding publisher`

**Causa:** Workflow name no PyPI n√£o bate com o arquivo real

**Solu√ß√£o:** Verifique que o workflow name est√° **exatamente**:
- ‚úÖ `auto_tag_publish_development.yml` (para development)
- ‚úÖ `auto_tag_publish_master.yml` (para master)
- ‚ùå N√£o use nomes antigos ou varia√ß√µes

---

### GitHub Secrets

#### CODECOV_TOKEN
- **Onde:** Repository Settings ‚Üí Secrets ‚Üí Actions
- **Uso:** Upload de cobertura de testes
- **Como obter:** https://codecov.io

---

### GitHub Environments (Opcional)

Se usar environments, configure em: Settings ‚Üí Environments

#### Environment: development
- Sem prote√ß√µes especiais (deploy autom√°tico)
- Ou com revisor opcional

#### Environment: production
- Revisores obrigat√≥rios recomendado
- Delay opcional (ex: 5 minutos)
- Prote√ß√£o de branch: apenas master

---

## üí° Como Usar

### Desenvolvimento Di√°rio

```bash
# 1. Feature branch
git checkout -b feature/nome-da-feature

# 2. Desenvolver, testar localmente
poetry run pytest tests/ -v

# 3. Commit
git add .
git commit -m "feat: descri√ß√£o"

# 4. Push
git push origin feature/nome-da-feature

# 5. Criar PR ‚Üí development
# 6. Aguardar valida√ß√£o e merge
# 7. Tag RC criada automaticamente!
```

### Testes Locais

#### Testar l√≥gica de RC tagging
```bash
./.github/test_tag_logic.sh
```

#### Verificar configura√ß√£o PyPI
```bash
./.github/check_pypi_config.sh
```

#### Rodar testes completos
```bash
poetry run pytest tests/ -v --cov=rand_engine
```

---

## üì¶ Melhores Pr√°ticas Implementadas

### ‚úÖ Build e Packaging
- [x] Build com Poetry 2.0.1
- [x] Valida√ß√£o de metadata com `twine check`
- [x] Teste de instala√ß√£o antes de publicar
- [x] Artifacts salvos (30 dias dev, 90 dias prod)
- [x] Wheel (.whl) e Source Distribution (.tar.gz)

### ‚úÖ Testing
- [x] Testes em Python 3.10, 3.11, 3.12 (matriz)
- [x] Coverage tracking com Codecov
- [x] Cache de depend√™ncias Poetry
- [x] Fail-fast desabilitado (v√™ todos os erros)

### ‚úÖ Versioning
- [x] SemVer compliance (X.Y.Zrc[N])
- [x] RC incremento autom√°tico (rc1, rc2, rc3, ...)
- [x] Tags anotadas com metadata detalhada
- [x] Changelog autom√°tico entre vers√µes

### ‚úÖ Security
- [x] PyPI Trusted Publishing (OIDC)
- [x] Environments com prote√ß√£o opcional
- [x] Permiss√µes m√≠nimas necess√°rias
- [x] Secrets management com GitHub Secrets

### ‚úÖ Deployment
- [x] Deploy apenas ap√≥s merge de PR
- [x] Valida√ß√£o de tag existente (evita duplica√ß√£o)
- [x] Rollback prevention
- [x] Verifica√ß√£o p√≥s-publica√ß√£o

### ‚úÖ Observabilidade
- [x] GitHub Actions Summary visual
- [x] Logs detalhados com emojis
- [x] Status de cada job
- [x] Links para PyPI e GitHub Release
- [x] Pr√≥ximos passos sugeridos

---

## üîç Diferen√ßas entre Workflows

| Feature | Development (RC) | Master (Production) |
|---------|-----------------|---------------------|
| **Trigger** | PR merged ‚Üí development | PR merged ‚Üí master |
| **Tag Format** | `X.Y.Zrc[N]` | `X.Y.Z` |
| **Incremento** | Autom√°tico (rc1, rc2, rc3) | Sem incremento |
| **PyPI** | Pre-release | Stable |
| **GitHub** | Pre-Release | Release (latest) |
| **Environment** | development (opcional) | production (opcional) |
| **Valida√ß√£o Vers√£o** | Aceita RC format | Rejeita se tiver RC |
| **Changelog** | Desde √∫ltimo RC | Desde √∫ltimo RC ou stable |
| **Jobs** | 7 jobs | 6 jobs + skip |
| **Artifact Retention** | 30 dias | 90 dias |

---

## üéâ Benef√≠cios da Nova Arquitetura

### Antes (Sistema Antigo)
- ‚ùå Tags alpha/beta/rc misturadas
- ‚ùå L√≥gica complexa de evolu√ß√£o
- ‚ùå Formato inconsistente
- ‚ùå Dif√≠cil de entender sequ√™ncia
- ‚ùå Jobs monol√≠ticos
- ‚ùå Pouca visibilidade

### Depois (Sistema Atual)
- ‚úÖ **Apenas RC** para pre-release
- ‚úÖ **Incremento simples** (rc1, rc2, rc3)
- ‚úÖ **Formato consistente** sempre
- ‚úÖ **Claro e previs√≠vel**
- ‚úÖ **Produ√ß√£o limpa** (sem sufixos)
- ‚úÖ **7 jobs modulares** com valida√ß√µes
- ‚úÖ **Melhores pr√°ticas** Python packaging
- ‚úÖ **Observabilidade completa**

---

## üìö Refer√™ncias

### Documenta√ß√£o Oficial
- [PyPI Trusted Publishing](https://docs.pypi.org/trusted-publishers/)
- [GitHub Actions](https://docs.github.com/en/actions)
- [Poetry Documentation](https://python-poetry.org/docs/)
- [Semantic Versioning](https://semver.org/)

### Ferramentas de Seguran√ßa
- [Bandit](https://bandit.readthedocs.io/) - Python security scanner
- [Semgrep](https://semgrep.dev/docs/) - Advanced static analysis
- [Safety](https://pyup.io/safety/) - Dependency vulnerability scanner
- [Trivy](https://aquasecurity.github.io/trivy/) - Comprehensive security scanner
- [CodeQL](https://codeql.github.com/) - GitHub Advanced Security

### Security Standards
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [CWE Top 25](https://cwe.mitre.org/top25/)
- [NIST Guidelines](https://nvd.nist.gov/)

### Scripts de Utilidade
- `.github/test_tag_logic.sh` - Testa l√≥gica de RC localmente
- `.github/check_pypi_config.sh` - Diagn√≥stico de configura√ß√£o

### Workflows
- `.github/workflows/test_on_push.yml` - Testes em feature branches
- `.github/workflows/pr_to_development.yml` - Valida√ß√£o de PR + Security
- `.github/workflows/pr_to_master.yml` - Valida√ß√£o strict de PR
- `.github/workflows/auto_tag_publish_development.yml` - RC deployment
- `.github/workflows/auto_tag_publish_master.yml` - Production deployment

### Configura√ß√µes
- `.bandit` - Configura√ß√£o do Bandit security scanner
- `pyproject.toml` - Poetry configuration e vers√£o do projeto


---

## üìù Checklist de Setup Inicial

- [ ] Branches `master` e `development` criadas e protegidas
- [ ] Configurei PyPI Trusted Publishing para `auto_tag_publish_development.yml`
- [ ] Configurei PyPI Trusted Publishing para `auto_tag_publish_master.yml`
- [ ] Adicionei `CODECOV_TOKEN` nos GitHub Secrets
- [ ] (Opcional) Configurei GitHub Environments: `development` e `production`
- [ ] Testei `.github/test_tag_logic.sh` localmente
- [ ] Li e entendi o fluxo completo
- [ ] Fiz primeiro merge em development para testar RC deployment
- [ ] Verifiquei tag RC criada no GitHub
- [ ] Verifiquei pacote RC no PyPI
- [ ] Instalei e testei: `pip install rand-engine==0.5.5rc1`

---

## üöÄ Status Atual

**‚úÖ Sistema Implementado e Pronto para Uso**

- **Workflows:** 5 workflows funcionais com visual summaries
- **Seguran√ßa:** 5 ferramentas de an√°lise (Bandit, Semgrep, Safety, Trivy, CodeQL)
- **Testes:** Cobertura em 3 vers√µes Python (3.10, 3.11, 3.12)
- **Coverage:** Enforcement de m√≠nimo 60%
- **Otimiza√ß√£o:** Testes sem duplica√ß√£o (~66% economia)
- **Publishing:** PyPI Trusted Publishing (OIDC) configur√°vel
- **Observabilidade:** Logs detalhados e sum√°rios visuais em todos os workflows
- **Documenta√ß√£o:** Completa e atualizada

**üéØ Pr√≥ximos Passos:**
1. Configurar PyPI Trusted Publishing (development + production)
2. Adicionar `CODECOV_TOKEN` nos GitHub Secrets
3. Testar com merge em development (RC deployment)
4. Validar seguran√ßa e coverage
5. Testar promo√ß√£o para production

---

**Documenta√ß√£o atualizada:** 2025-10-17  
**Vers√£o do sistema:** RC-only com seguran√ßa e visual summaries  
**Arquivos consolidados:** README.md, POETRY_EXPORT_FIX.md, MASTER_SUMMARY_ENHANCEMENT.md, TEST_ON_PUSH_SUMMARY.md, SECURITY_IMPROVEMENTS.md

