name: Master - Auto Tag and Publish

on:
  pull_request:
    types: [closed]
    branches:
      - master

env:
  PYTHON_VERSION: "3.12"
  PACKAGE_NAME: "rand-engine"

jobs:
  # Job 1: Prepare production release
  prepare:
    name: Prepare Production Release
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract_version.outputs.version }}
      tag_exists: ${{ steps.check_tag.outputs.tag_exists }}
      latest_rc: ${{ steps.find_rc.outputs.latest_rc }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract version from pyproject.toml
        id: extract_version
        run: |
          VERSION=$(grep -E '^version = "[0-9]+\.[0-9]+\.[0-9]+"' pyproject.toml | sed -E 's/version = "(.*)"/\1/')
          if [ -z "$VERSION" ]; then
            echo "‚ùå Failed to extract version from pyproject.toml"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Production version: $VERSION"
      
      - name: Check if tag already exists
        id: check_tag
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "tag_exists=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Tag $VERSION already exists - will skip deployment"
          else
            echo "tag_exists=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Tag $VERSION does not exist yet"
          fi
      
      - name: Find latest RC tag
        id: find_rc
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"
          LATEST_RC=$(git tag -l "${VERSION}rc*" | grep -E "^${VERSION}rc[0-9]+$" | sort -V | tail -1 || echo "")
          if [ -n "$LATEST_RC" ]; then
            echo "latest_rc=$LATEST_RC" >> $GITHUB_OUTPUT
            echo "üìã Latest RC tag found: $LATEST_RC"
          else
            echo "latest_rc=" >> $GITHUB_OUTPUT
            echo "üìã No RC tags found for version $VERSION"
          fi

  # Job 2: Run tests
  test:
    name: Run Tests (Python ${{ matrix.python-version }})
    needs: prepare
    if: needs.prepare.outputs.tag_exists == 'false'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Install dependencies
        run: poetry install --with test --no-interaction
      - name: Run tests
        run: poetry run pytest tests/ -v

  # Job 3: Build and validate
  build:
    name: Build Production Package
    needs: [prepare, test]
    if: needs.prepare.outputs.tag_exists == 'false'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Verify version (no RC suffix)
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          if echo "$VERSION" | grep -q "rc"; then
            echo "‚ùå Production version should not contain 'rc' suffix!"
            exit 1
          fi
          echo "‚úÖ Production version: $VERSION"
      - name: Build package
        run: poetry build
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-production-${{ needs.prepare.outputs.version }}
          path: dist/

  # Job 4: Create production tag
  create_tag:
    name: Create Production Tag
    needs: [prepare, build]
    if: needs.prepare.outputs.tag_exists == 'false'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Create and push tag
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$VERSION" -m "Production Release $VERSION"
          git push origin "$VERSION"

  # Job 5: Publish to PyPI
  publish_pypi:
    name: Publish to PyPI (Production)
    needs: [prepare, build, create_tag]
    if: needs.prepare.outputs.tag_exists == 'false'
    runs-on: ubuntu-latest
    environment:
      name: production
    permissions:
      id-token: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: dist-production-${{ needs.prepare.outputs.version }}
          path: dist/
      - uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          verbose: true

  # Job 6: Create GitHub Release
  create_github_release:
    name: Create GitHub Release
    needs: [prepare, build, create_tag, publish_pypi]
    if: needs.prepare.outputs.tag_exists == 'false'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/download-artifact@v4
        with:
          name: dist-production-${{ needs.prepare.outputs.version }}
          path: dist/
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          LATEST_RC="${{ needs.prepare.outputs.latest_rc }}"
          
          NOTES="## üöÄ Production Release v$VERSION"
          if [ -n "$LATEST_RC" ]; then
            NOTES="$NOTES

          Promoted from Release Candidate: **$LATEST_RC**"
          fi
          
          gh release create "$VERSION" dist/* \
            --title "üöÄ Release v$VERSION" \
            --notes "$NOTES" \
            --latest

  # Job 7: Deployment Summary
  summary:
    name: Production Deployment Summary
    needs: [prepare, test, build, create_tag, publish_pypi, create_github_release]
    runs-on: ubuntu-latest
    if: always() && needs.prepare.outputs.tag_exists == 'false'
    steps:
      - name: Generate Deployment Summary
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          LATEST_RC="${{ needs.prepare.outputs.latest_rc }}"
          
          echo "# üéâ Production Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Version Info
          echo "## üì¶ Version Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Production Version** | \`$VERSION\` |" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "$LATEST_RC" ]; then
            echo "| **Promoted from RC** | \`$LATEST_RC\` |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Promoted from RC** | _No RC found_ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "| **Git Tag** | [\`$VERSION\`](https://github.com/${{ github.repository }}/releases/tag/$VERSION) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered by** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Pipeline Status
          echo "## üîÑ Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1Ô∏è‚É£ Prepare | ${{ needs.prepare.result == 'success' && '‚úÖ Success' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 2Ô∏è‚É£ Tests (3.10, 3.11, 3.12) | ${{ needs.test.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3Ô∏è‚É£ Build Package | ${{ needs.build.result == 'success' && '‚úÖ Built' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 4Ô∏è‚É£ Create Tag | ${{ needs.create_tag.result == 'success' && '‚úÖ Created' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 5Ô∏è‚É£ Publish PyPI | ${{ needs.publish_pypi.result == 'success' && '‚úÖ Published' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 6Ô∏è‚É£ GitHub Release | ${{ needs.create_github_release.result == 'success' && '‚úÖ Created' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Deployment Links
          echo "## üîó Deployment Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### PyPI Package" >> $GITHUB_STEP_SUMMARY
          echo "üì¶ **Install:** \`pip install ${{ env.PACKAGE_NAME }}==$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîó **PyPI:** https://pypi.org/project/${{ env.PACKAGE_NAME }}/$VERSION/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### GitHub Release" >> $GITHUB_STEP_SUMMARY
          echo "üè∑Ô∏è **Tag:** https://github.com/${{ github.repository }}/releases/tag/$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìù **Release Notes:** https://github.com/${{ github.repository }}/releases/tag/$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Testing
          echo "## üß™ Testing the Release" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Create virtual environment" >> $GITHUB_STEP_SUMMARY
          echo "python -m venv venv" >> $GITHUB_STEP_SUMMARY
          echo "source venv/bin/activate  # or venv\\Scripts\\activate on Windows" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Install the new version" >> $GITHUB_STEP_SUMMARY
          echo "pip install ${{ env.PACKAGE_NAME }}==$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Verify installation" >> $GITHUB_STEP_SUMMARY
          echo "python -c \"import rand_engine; print(f'Version: {rand_engine.__version__}')\"" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Next Steps
          echo "## üéØ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Version **$VERSION** is now live in production" >> $GITHUB_STEP_SUMMARY
          echo "- üì¢ Announce release to users" >> $GITHUB_STEP_SUMMARY
          echo "- üìö Update documentation if needed" >> $GITHUB_STEP_SUMMARY
          echo "- üîÑ Start working on next version (e.g., bump to 0.5.6)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Success Message
          if [ "${{ needs.prepare.result }}" == "success" ] && \
             [ "${{ needs.test.result }}" == "success" ] && \
             [ "${{ needs.build.result }}" == "success" ] && \
             [ "${{ needs.create_tag.result }}" == "success" ] && \
             [ "${{ needs.publish_pypi.result }}" == "success" ] && \
             [ "${{ needs.create_github_release.result }}" == "success" ]; then
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## üéä Deployment Successful!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All jobs completed successfully. Version **$VERSION** is ready for production use! üöÄ" >> $GITHUB_STEP_SUMMARY
          else
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ‚ö†Ô∏è Deployment Issues" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some jobs failed. Please review the logs above." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # Job 8: Skip Notification (if tag already exists)
  skip_notification:
    name: Skip Deployment - Tag Exists
    needs: prepare
    if: needs.prepare.outputs.tag_exists == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Tag Already Exists
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          
          echo "# ‚è≠Ô∏è Deployment Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ‚ÑπÔ∏è Tag Already Exists" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Version **\`$VERSION\`** has already been released." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîç Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | \`$VERSION\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | ‚è≠Ô∏è Already deployed |" >> $GITHUB_STEP_SUMMARY
          echo "| **Reason** | Tag exists in repository |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó Existing Release" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- üè∑Ô∏è **Tag:** https://github.com/${{ github.repository }}/releases/tag/$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- üì¶ **PyPI:** https://pypi.org/project/${{ env.PACKAGE_NAME }}/$VERSION/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üí° What to do?" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "If you want to release a new version:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Update \`pyproject.toml\` with new version (e.g., \`0.5.6\`)" >> $GITHUB_STEP_SUMMARY
          echo "2. Commit: \`git commit -m \"chore: bump version to 0.5.6\"\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Create PR to \`development\` branch" >> $GITHUB_STEP_SUMMARY
          echo "4. After testing, create PR from \`development\` to \`master\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ÑπÔ∏è No action needed - workflow completed successfully."
